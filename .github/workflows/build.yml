name: Build VLC Whisper Plugin

on:
  push:
    branches: "main"
  pull_request:
    branches: "main"

jobs:
  build-windows:
    if: false
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v3

      - name: Download VLC SDK (3.0.21)
        shell: powershell
        run: |
          $VLC_VERSION = "3.0.21"
          $URL = "http://download.videolan.org/pub/videolan/vlc/${VLC_VERSION}/win64/vlc-${VLC_VERSION}-win64.7z"
          $OUT_FILE = "vlc.7z"

          Write-Host "Downloading VLC SDK from $URL..."
          Invoke-WebRequest -Uri $URL -OutFile $OUT_FILE

          Write-Host "Extracting..."
          7z x $OUT_FILE -oVLC_SDK_ROOT -y

          # Move SDK to a known path or set env var
          $SDK_PATH = Resolve-Path "VLC_SDK_ROOT\vlc-$VLC_VERSION\sdk"
          echo "VLC_ADDON_PATH=$SDK_PATH" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8
          Write-Host "VLC SDK set to $SDK_PATH"

      - name: Configure CMake
        run: |
          cmake -B build -S . -DCMAKE_BUILD_TYPE=Release -DVLC_LIB_DIR="${{ env.VLC_ADDON_PATH }}\lib" -DVLC_INCLUDE_DIRS="${{ env.VLC_ADDON_PATH }}\include"

      - name: Build
        run: cmake --build build --config Release

      - name: List directory tree
        run: |
          Get-ChildItem -Path build -Recurse | Format-Table -Property FullName

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: whisper_subs_dll
          path: build/Release/libwhisper_subs_plugin.dll

  build-linux:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      # ---- DEBUG: entorno base ----
      - name: Debug system info
        run: |
          uname -a
          lsb_release -a
          gcc --version
          cmake --version

      # ---- DEBUG: VLC runtime vs headers ----
      - name: Debug VLC packages versions
        run: |
          apt-cache policy vlc libvlc-dev libvlccore-dev || true
          dpkg -l | grep -E 'vlc|libvlc' || true

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libvlc-dev libvlccore-dev pkg-config cmake build-essential

      # ---- DEBUG: pkg-config (CRÍTICO para el entry point) ----
      - name: Debug pkg-config vlc-plugin
        run: |
          pkg-config --modversion vlc-plugin
          pkg-config --cflags vlc-plugin
          pkg-config --libs vlc-plugin

      # ---- DEBUG: headers reales usados ----
      - name: Debug vlc headers location
        run: |
          pkg-config --cflags vlc-plugin | tr ' ' '\n'
          ls -l /usr/include/vlc || true

      - name: Configure CMake
        run: |
          cmake -B build -S . \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_VERBOSE_MAKEFILE=ON

      # ---- DEBUG: flags efectivos de compilación ----
      - name: Debug compile commands
        run: |
          if [ -f build/compile_commands.json ]; then
            head -n 50 build/compile_commands.json
          else
            echo "compile_commands.json not generated"
          fi

      - name: Build
        run: cmake --build build --config Release --verbose

      # ---- DEBUG: binario generado ----
      - name: Debug plugin binary
        run: |
          ls -lh build
          file build/libwhisper_subs_plugin.so
          ldd build/libwhisper_subs_plugin.so || true

      # ---- DEBUG: ENTRY POINT (EL PROBLEMA QUE ESTÁS TENIENDO) ----
      - name: Debug VLC entry symbols
        run: |
          nm -D build/libwhisper_subs_plugin.so | grep vlc_entry || true
          readelf -Ws build/libwhisper_subs_plugin.so | grep vlc_entry || true

      # ---- DEBUG: visibilidad de símbolos ----
      - name: Debug exported symbols count
        run: |
          nm -D build/libwhisper_subs_plugin.so | wc -l

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: whisper_subs_so
          path: build/libwhisper_subs_plugin.so
